#!/usr/bin/perl
# This script is part of debbugs, and is released
# under the terms of the GPL version 2, or any later
# version at your option.
# See the file README and COPYING for more information.
#
# [Other people may have contributed to this file; their copyrights
# should go here too.]
# Copyright 2004 by Collin Watson <cjwatson@debian.org>
# Copyright 2007 by Don Armstrong <don@donarmstrong.com>



use Debbugs::Control qw(bug_archive);
use Debbugs::Status qw(bug_archiveable);

use Debbugs::Config qw(:config);

# No $gRemoveAge means "never expire".
exit 0 unless $config{remove_age};

chdir($config{spool}) || die "chdir $config{spool} failed: $!\n";

#get list of bugs (ie, status files)
opendir(DIR,"db-h") || &quit("opendir db: $!\n");
@dirs = sort { $a <=> $b } grep(s,^,db-h/,, grep(m/^\d+$/,readdir(DIR)));
close(DIR);
foreach my $dir (@dirs) {
    opendir(DIR,$dir);
    push @list, sort { $a <=> $b } grep(s/\.summary$//,grep(m/^\d+\.summary$/,readdir(DIR)));
    close(DIR);
}

my $bug;
my $errors=0;
#process each bug (ie, status file)
while (length($bug=shift(@list))) {
     # Weeeee.
     next unless bug_archiveable(bug=>$bug);
     eval {
	  bug_archive(bug=>$bug);
     };
     if ($@) {
	  $errors=1;
	  print STDERR "Unable to archive bug# $bug which I thought I could archive:\n$@\n";
     }
}

exit $errors;
